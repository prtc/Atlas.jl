# Phase 5: Minimal Working SYNTHE Pipeline - Test Data

**Purpose**: This directory contains all test data and reference outputs for Phase 5 implementation (solar spectrum 5000-5100 Å, flux only).

**Created**: 2025-11-11 (Task 0)

---

## Directory Structure

```
test/phase5_minimal_synthe/
├── README.md                     # This file
├── input/                        # Paula provides
│   ├── atmosphere/
│   │   └── solar_atlas12.mod     # Solar atmosphere model (T_eff=5777K, log g=4.44)
│   ├── line_lists/
│   │   ├── atomic/
│   │   │   └── gf5000.asc        # Atomic lines 5000-5100 Å (Kurucz gfall format)
│   │   └── molecular/
│   │       ├── ch.asc            # CH molecular lines
│   │       ├── cn.asc            # CN molecular lines
│   │       └── co.asc            # CO molecular lines
│   └── synthe_params.txt         # SYNTHE run parameters
│
├── fortran_reference/            # Paula's Fortran outputs
│   ├── fort.7                    # Final spectrum (wavelength, flux)
│   ├── fort.93                   # synbeg initialization parameters
│   ├── fort.12                   # Combined line list (binary)
│   ├── run_log.txt               # Fortran execution log
│   └── atlas7v_library/          # Compiled atlas7v library (optional)
│       └── libaslave7v.so        # Shared library for ccall
│
└── julia_output/                 # Generated by Julia code
    ├── spectrum.dat              # Julia-generated spectrum
    └── comparison_plot.png       # Julia vs Fortran comparison
```

---

## Paula's Action Items

### 1. Upload Atmosphere Model

**File**: `input/atmosphere/solar_atlas12.mod`

**What it is**: ATLAS12-format solar atmosphere model

**Requirements**:
- T_eff = 5777 K (solar)
- log g = 4.44 (solar)
- Solar abundances (standard)
- Any ATLAS12 or ATLAS9 model format is fine

**Where to get it**:
- Use your existing solar model
- OR: Kurucz online atlas (http://kurucz.harvard.edu/grids.html)
- OR: Castelli & Kurucz (2003) grid

**Format**: ASCII text file with standard ATLAS model structure

---

### 2. Upload Atomic Line Lists

**File**: `input/line_lists/atomic/gf5000.asc`

**What it is**: Kurucz gfall-format atomic lines for 5000-5100 Å

**Requirements**:
- Wavelength range: 4990-5110 Å (add 10 Å margin for line wings)
- Format: Kurucz gfall ASCII format (fixed-width columns)
- Same file you use for Fortran runs

**How to create** (if you don't have a pre-filtered file):
```bash
# From full gfallvac08oct17.dat (or similar):
awk '$1 >= 4990 && $1 <= 5110' gfallvac08oct17.dat > gf5000.asc
```

**Example line** (from Deep Dive 12):
```
 2600.1720 -2.570 26.0  18500.123  3.5  57002.456  2.5 'a 5D      ' 'z 5P*     '
```

**Format specification** (F11.4, F7.3, F6.2, F12.3, F5.1, F12.3, F5.1, A1, A10, A10):
- Column 1-11: Wavelength (Å)
- Column 12-18: log(gf)
- Column 19-24: Element.ion code (e.g., 26.00 = Fe I)
- Column 25-36: Lower level energy (cm⁻¹)
- Column 37-41: Lower level J
- Column 42-53: Upper level energy (cm⁻¹)
- Column 54-58: Upper level J
- Column 59: Identification flag
- Column 60-69: Lower level term
- Column 70-79: Upper level term

---

### 3. Upload Molecular Line Lists

**Files**:
- `input/line_lists/molecular/ch.asc`
- `input/line_lists/molecular/cn.asc`
- `input/line_lists/molecular/co.asc`

**What they are**: Molecular line lists in ASCII format

**Requirements**:
- Wavelength range: 4990-5110 Å (same 10 Å margin)
- Format: rmolecasc-compatible ASCII format
- Same files you use for Fortran runs

**Why these molecules?**:
- Solar spectrum at 5000-5100 Å has CH, CN, CO features
- We're skipping TiO, H2O (cool star only, not needed for solar)

**Where to get them**:
- Your existing molecular line list directory
- Kurucz molecular data (http://kurucz.harvard.edu/molecules.html)

**Example format** (varies by molecule, but typically):
```
wavelength  log(gf)  E_lower  E_upper  ISO  [additional fields...]
```

**Note**: If you don't have pre-filtered molecular files, you can provide the full files and we'll filter them in Julia. Just upload whatever you use for Fortran SYNTHE runs.

---

### 4. Upload SYNTHE Parameters

**File**: `input/synthe_params.txt`

**What it is**: SYNTHE run parameters (for documentation, not used by Julia yet)

**Contents** (simple text file):
```
WLBEG=5000.0          # Start wavelength (Å)
WLEND=5100.0          # End wavelength (Å)
RESOLU=50000.0        # Resolving power (R = λ/Δλ)
TURBV=2.0             # Microturbulence (km/s)
IFVAC=1               # 1=vacuum wavelengths, 0=air
IFNLTE=0              # 0=LTE (for Phase 5)
CUTOFF=0.001          # Line cutoff strength
```

**Why needed**: Documents exactly what parameters you used for Fortran run, ensures Julia uses same values.

---

### 5. Run Fortran SYNTHE and Upload Outputs

**Goal**: Generate reference outputs for validation

#### 5a. Run SYNTHE Pipeline

Using the same input files uploaded above, run your standard SYNTHE pipeline:

```bash
# Typical SYNTHE workflow:
synbeg          # Initialize fort.93
rgfalllinesnew  # Read atomic lines
rmolecasc       # Read molecular lines (CH, CN, CO only)
# Skip rschwenk (TiO), rh2ofast (H2O) for solar
xnfpelsyn       # Prepare atmosphere
synthe          # Compute line opacities
spectrv         # Synthesize spectrum
broaden         # Apply instrumental broadening (optional)
```

#### 5b. Upload Fortran Outputs

**Required files**:
1. **fort.7** → `fortran_reference/fort.7`
   - Final spectrum output (wavelength, flux columns)
   - This is the gold standard we'll compare Julia against
   - Format: ASCII, two columns (wavelength, flux)

2. **fort.93** → `fortran_reference/fort.93` (optional but helpful)
   - SYNTHE initialization parameters from synbeg
   - Binary file, used for debugging

3. **fort.12** → `fortran_reference/fort.12` (optional)
   - Combined line list from readers
   - Binary file, useful for debugging line reader issues

4. **run_log.txt** → `fortran_reference/run_log.txt`
   - Capture stdout from your SYNTHE run
   - Helps us debug if something goes wrong
   - Just redirect output: `./run_synthe.sh > run_log.txt 2>&1`

**Example fort.7 format**:
```
5000.000   1.234e-5
5000.020   1.235e-5
5000.040   1.237e-5
...
5100.000   1.456e-5
```

---

### 6. Compile atlas7v Library (When Ready)

**File**: `fortran_reference/atlas7v_library/libaslave7v.so`

**What it is**: Shared library containing POPS, KAPP, JOSH, etc. for ccall

**Compilation command**:
```bash
cd upstream/kurucz/source_codes/programs/atlas12/

gfortran -shared -fPIC -O2 -o libaslave7v.so atlas7v.for
```

**Verify compilation**:
```bash
nm -D libaslave7v.so | grep -i pops
# Should show: pops_ (or POPS_ depending on compiler)

nm -D libaslave7v.so | grep -i kapp
# Should show: kapp_

nm -D libaslave7v.so | grep -i josh
# Should show: josh_
```

**When to do this**: We can start on Tasks 2-4 (line readers) without this. We'll need it before Task 1 (atlas7v interface).

**Note**: If you have trouble compiling, don't worry! We can work around it temporarily or I can help debug the compilation.

---

## Expected Timeline

| When | What Paula Provides | What Julia Code Needs |
|------|---------------------|----------------------|
| **Now** | Atmosphere model, line lists, parameters | None (just setting up) |
| **Day 1-2** | Fortran reference outputs (fort.7, etc.) | Tasks 2-4 (line readers) |
| **Day 3-4** | Compiled atlas7v.so | Task 1 (ccall interface) |

You can provide these incrementally! We'll start implementing line readers while you prepare the Fortran reference run.

---

## Validation Strategy

Once Julia code is complete, we'll compare:

1. **Line counts**: Number of lines read by Julia vs Fortran
2. **Wavelength grid**: Julia and Fortran should use identical grid
3. **Spectrum values**: Flux at each wavelength point
   - Target tolerance: < 1% difference
   - Plot overlay: Julia vs Fortran spectrum

**Success criteria**:
- ✅ Julia spectrum visually matches Fortran (< 1% error)
- ✅ Strong lines in correct positions
- ✅ Continuum level matches
- ✅ No systematic offsets or scaling issues

---

## Questions & Troubleshooting

### Q: Which gfall file should I use?

**A**: Any recent Kurucz gfall file is fine. Common ones:
- gfallvac08oct17.dat (2017 version, vacuum wavelengths)
- gfall08oct17.dat (2017 version, air wavelengths)
- gfallweb11oct17.dat (web version)

Just use whatever you currently use for production SYNTHE runs.

### Q: Do I need to convert wavelengths vacuum ↔ air?

**A**: Not yet! For Phase 5, we'll match your Fortran behavior exactly. Just document which convention you're using in `synthe_params.txt` (IFVAC=1 for vacuum, 0 for air).

The vacuum-air conversion issue (flagged by Marcos) is for later validation, not Phase 5.

### Q: What if my fort.7 has extra columns?

**A**: That's fine! We only need wavelength (column 1) and flux (column 2). Additional columns (e.g., continuum flux) are OK to include but we'll ignore them for Phase 5.

### Q: What if compilation of atlas7v fails?

**A**: We can proceed without it for Tasks 2-4 (line readers). If compilation is problematic, we have backup options:
- Use Fortran-generated intermediate files instead of ccall
- Focus on line readers only for Phase 5
- Debug compilation together

### Q: Can I use different parameters?

**A**: Yes! The 5000-5100 Å solar case is just our suggested test. If you prefer:
- Different wavelength range (e.g., 6000-6100 Å for H-alpha)
- Different star (but solar is simplest for Phase 5)
- Different resolving power

Just document your choice in `synthe_params.txt` and we'll adapt.

---

## File Upload Instructions

**Option 1: Direct copy** (if using Claude Code desktop)
- Copy files directly to this directory structure

**Option 2: Tar archive** (if using Claude Code web)
```bash
cd /path/to/your/data
tar czf phase5_input.tar.gz atmosphere/ line_lists/ synthe_params.txt
# Upload phase5_input.tar.gz
# I'll extract it: tar xzf phase5_input.tar.gz
```

**Option 3: Tell me the paths** (if files are already in Atlas.jl repo)
- Just tell me where they are, I'll copy them

---

## Next Steps

After you upload data:
1. I'll verify file formats (quick sanity checks)
2. Start implementing line readers (Tasks 2-4)
3. You compile atlas7v (when convenient)
4. I implement ccall interface (Task 1)
5. Continue through pipeline (Tasks 5-9)

---

**Created**: 2025-11-11 (Task 0: Phase 5 Preparation)
**For**: Paula (data preparation) and future Claude sessions (test data location)
**Version**: 1.0
