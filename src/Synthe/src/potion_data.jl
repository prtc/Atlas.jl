"""
POTION ionization potential array from NIST ASD

Extracted from rgfall.for SUBROUTINE IONPOTS (lines 334-648)

Data source: Kramida, A., Ralchenko, Yu., Reader, J., and NIST ASD Team (2014).
NIST Atomic Spectra Database (ver. 5.2). physics.nist.gov/asd

Units: cm⁻¹ (convert to eV by dividing by 8065.479)

Array structure:
- Elements 1-30: Full ionization stages (Z+1 values each)
- Elements 31-99: First 5 ionization stages only
- Total: 999 values

Index mapping via EQUIVALENCE statements:
- H (Z=1): indices 1-2
- He (Z=2): indices 3-5
- ...
- Fe (Z=26): indices 351-377
- ...
- Es (Z=99): indices 836-840

Author: Extracted by Python script from Fortran source
Date: 2025-11-15
"""

# Conversion factor cm⁻¹ → eV
const CM_INV_TO_EV = 8065.479

# Complete POTION array (999 elements) in cm⁻¹ units
const POTION_ARRAY_CM_INV = Float64[
    109678.772, 0.000, 198310.666, 438908.879, 0.000, 43487.114, 610078.526, 987661.014, 0.000, 75192.640,
    146882.860, 1241256.600, 1756018.822, 0.000, 66928.040, 202887.400, 305930.800, 2091972.000, 2744107.936, 0.000,
    90820.420, 196674.000, 386241.000, 520175.800, 3162423.300, 3952061.670, 0.000, 117225.700, 238750.200, 382672.000,
    624866.000, 789537.000, 4452723.300, 5380089.800, 0.000, 109837.020, 283270.900, 443085.000, 624382.000, 918657.000,
    1114004.000, 5963073.000, 7028394.700, 0.000, 140524.500, 282058.600, 505774.000, 703110.000, 921480.000, 1267606.000,
    1493632.000, 7693706.600, 8897242.500, 0.000, 173929.750, 330388.600, 511544.000, 783890.000, 1018250.000, 1273820.000,
    1671750.000, 1928447.000, 9644840.700, 10986877.200, 0.000, 41449.451, 381390.200, 577654.000, 797970.000, 1116300.000,
    1389100.000, 1681700.000, 2130850.000, 2418500.000, 11817106.700, 13297680.000, 0.000, 61671.050, 121267.610, 646402.000,
    881285.000, 1139900.000, 1506300.000, 1814900.000, 2144820.000, 2645400.000, 2964000.000, 14209914.700, 15829950.000, 0.000,
    48278.480, 151862.500, 229445.700, 967804.000, 1240684.000, 1536400.000, 1949900.000, 2295800.000, 2663300.000, 3215300.000,
    3565010.000, 16824539.300, 18584143.000, 0.000, 65747.760, 131838.140, 270139.300, 364093.100, 1345070.000, 1655590.000,
    1986700.000, 2449200.000, 2831800.000, 3237400.000, 3840600.000, 4221630.000, 19661038.900, 21560631.000, 0.000, 84580.830,
    159451.700, 243600.700, 414922.800, 524462.900, 1777890.000, 2125800.000, 2497100.000, 3002900.000, 3423000.000, 3867000.000,
    4521700.000, 4934020.000, 22719901.600, 24759942.000, 0.000, 83559.100, 188232.700, 281100.000, 380870.000, 585514.000,
    710195.000, 2266050.000, 2651900.000, 3063600.000, 3611300.000, 4069500.000, 4552200.000, 5258400.000, 5702290.000, 26001545.100,
    28182526.000, 0.000, 104591.000, 192070.000, 321000.000, 429400.000, 545800.000, 781900.000, 921096.000, 2809280.000,
    3233080.000, 3683000.000, 4274000.000, 4771400.000, 5293400.000, 6051000.000, 6526620.000, 29506532.500, 31828983.000, 0.000,
    127109.842, 222848.300, 328550.000, 480600.000, 603700.000, 736300.000, 1003400.000, 1157056.000, 3408500.000, 3869500.000,
    4359000.000, 4992000.000, 5528700.000, 6090500.000, 6899800.000, 7407190.000, 33235410.000, 35699895.000, 0.000, 35009.814,
    255072.800, 369427.000, 491330.000, 666700.000, 802000.000, 948200.000, 1249100.000, 1418063.000, 4062400.000, 4562000.000,
    5090000.000, 5764000.000, 6342000.000, 6943800.000, 7805000.000, 8344140.000, 37189176.000, 39795784.000, 0.000, 49305.924,
    95751.870, 410642.300, 542595.000, 680200.000, 877400.000, 1026000.000, 1187600.000, 1520600.000, 1704050.000, 4771600.000,
    5309000.000, 5877000.000, 6591000.000, 7210000.000, 7853000.000, 8766000.000, 9337690.000, 41367028.000, 44117409.000, 0.000,
    52922.000, 103237.100, 199677.370, 592732.000, 741600.000, 892700.000, 1113000.000, 1275000.000, 1452000.000, 1816200.000,
    2014760.000, 5543900.000, 6111000.000, 6720000.000, 7473000.000, 8135000.000, 8820000.000, 9784000.000, 10388070.000, 45771185.000,
    48665510.000, 0.000, 55072.500, 109494.000, 221735.600, 348973.300, 800900.000, 964100.000, 1134700.000, 1375000.000,
    1549000.000, 1741500.000, 2137900.000, 2351110.000, 6353000.000, 6969000.000, 7618000.000, 8408000.000, 9116000.000, 9842000.000,
    10859000.000, 11495470.000, 50401766.000, 53440740.000, 0.000, 54411.670, 117900.000, 236410.000, 376730.000, 526532.000,
    1033400.000, 1215700.000, 1399800.000, 1661000.000, 1859000.000, 2055000.000, 2488200.000, 2712230.000, 7227000.000, 7882000.000,
    8573000.000, 9398000.000, 10153000.000, 10922000.000, 11991000.000, 12660130.000, 55259549.000, 58443920.000, 0.000, 54575.600,
    132971.020, 249700.000, 396500.000, 560200.000, 731020.000, 1292800.000, 1490200.000, 1690100.000, 1972000.000, 2184000.000,
    2393000.000, 2860500.000, 3098480.000, 8159000.000, 8850000.000, 9582000.000, 10443000.000, 11247000.000, 12059000.000, 13180000.000,
    13882280.000, 60345293.000, 63675850.000, 0.000, 59959.400, 126145.000, 271550.000, 413000.000, 584000.000, 771100.000,
    961440.000, 1577000.000, 1789600.000, 2005400.000, 2308000.000, 2536000.000, 2771000.000, 3250000.000, 3509900.000, 9144000.000,
    9873000.000, 10649000.000, 11541000.000, 12398000.000, 13253000.000, 14427000.000, 15162200.000, 65659877.000, 69137430.000, 0.000,
    63737.704, 130655.400, 247220.000, 442900.000, 604900.000, 798370.000, 1008000.000, 1218380.000, 1884000.000, 2114000.000,
    2346000.000, 2668000.000, 2912000.000, 3163000.000, 3680000.000, 3946570.000, 10184000.000, 10951000.000, 11770000.000, 12708000.000,
    13607000.000, 14505000.000, 15731000.000, 16500160.000, 71204137.000, 74829550.000, 0.000, 63564.600, 137795.000, 270200.000,
    413500.000, 641200.000, 822700.000, 1040000.000, 1273000.000, 1501300.000, 2221000.000, 2462600.000, 2711000.000, 3053000.000,
    3307000.000, 3558000.000, 4129200.000, 4408530.000, 11269000.000, 12135000.000, 12950000.000, 13900000.000, 14873000.000, 15815000.000,
    17094000.000, 17896440.000, 76979030.000, 80753210.000, 0.000, 61619.770, 146541.560, 283800.000, 443000.000, 613500.000,
    871000.000, 1065000.000, 1307000.000, 1558000.000, 1812000.000, 2577000.000, 2836100.000, 3102000.000, 3463000.000, 3732000.000,
    3995000.000, 4606000.000, 4895950.000, 12429000.000, 13274000.000, 14180000.000, 15170000.000, 16196000.000, 17183000.000, 18515000.000,
    19351330.000, 82985464.000, 86909350.000, 0.000, 62317.460, 163669.200, 297140.000, 462800.000, 644000.000, 831000.000,
    1121000.000, 1339000.000, 1597000.000, 1873000.000, 2140000.000, 2960000.000, 3234000.000, 3517000.000, 3897000.000, 4184000.000,
    4458000.000, 5101000.000, 5408820.000, 13635000.000, 14518000.000, 15470000.000, 16480000.000, 17578000.000, 18610000.000, 19995000.000,
    20865190.000, 89224526.000, 93299090.000, 0.000, 75769.328, 144892.600, 320390.000, 480490.000, 666000.000, 871000.000,
    1080000.000, 1403000.000, 1637000.000, 1920000.000, 2213000.000, 2507000.000, 3368000.000, 3657000.000, 3957000.000, 4355000.000,
    4660000.000, 4946000.000, 5626000.000, 5947260.000, 14896000.000, 15820000.000, 16820000.000, 17860000.000, 19019000.000, 20095000.000,
    21534000.000, 22438310.000, 95697194.000, 99923450.000, 0.000, 48387.634, 165465.800, 247820.000, 510070.000, 693700.000,
    63713.240, 128521.300, 274693.000, 368720.000, 729930.000, 78950.000, 149932.000, 228650.000, 404500.000, 506200.000,
    78658.350, 170960.000, 255650.000, 346390.000, 550900.000, 95284.800, 174140.000, 282000.000, 385400.000, 480670.000,
    112914.433, 196475.400, 287700.000, 410100.000, 521800.000, 33690.810, 220105.000, 316550.000, 421000.000, 552000.000,
    45932.204, 88965.180, 345879.000, 453930.000, 570000.000, 50145.600, 98590.000, 165540.500, 488830.000, 604700.000,
    53506.000, 105900.000, 186880.000, 277602.800, 648050.000, 54513.800, 115500.000, 202000.000, 303350.000, 407897.000,
    57204.300, 130300.000, 218800.000, 325300.000, 439450.000, 57421.680, 123100.000, 238300.000, 331000.000, 460000.000,
    59366.400, 135200.000, 229600.000, 363000.000, 476000.000, 60160.100, 145800.000, 250500.000, 339000.000, 508000.000,
    67241.300, 156700.000, 265600.000, 371000.000, 492000.000, 61106.450, 173283.000, 280900.000, 395000.000, 524000.000,
    72540.070, 136374.740, 302200.000, 411000.000, 548000.000, 46670.104, 152200.100, 226191.300, 447200.000, 559000.000,
    59232.690, 118017.000, 246020.000, 328600.000, 621300.000, 69431.340, 134100.000, 204248.000, 353300.000, 443600.000,
    72667.800, 150000.000, 224500.000, 301776.000, 478000.000, 84295.100, 154304.000, 238500.000, 325500.000, 415500.000,
    97833.787, 169180.000, 250400.000, 340400.000, 437000.000, 31406.468, 186777.400, 267740.000, 347000.000, 452000.000,
    42034.910, 80686.300, 289100.000, 379000.000, 468000.000, 44981.000, 90212.500, 154675.000, 402900.000, 497000.000,
    44672.000, 87500.000, 162903.000, 297670.000, 528700.000, 44140.000, 85100.000, 174407.000, 314400.000, 464000.000,
    44562.000, 86500.000, 178600.000, 326000.000, 483900.000, 45020.000, 87900.000, 180000.000, 331000.000, 498000.000,
    45519.600, 89300.000, 189000.000, 334000.000, 505000.000, 45734.740, 90660.000, 201000.000, 344000.000, 510000.000,
    49601.450, 97500.000, 166400.000, 355000.000, 522000.000, 47295.000, 92900.000, 176700.000, 317500.000, 536000.000,
    47901.700, 94100.000, 185000.000, 334000.000, 501000.000, 48567.000, 95200.000, 184200.000, 343000.000, 516000.000,
    49262.000, 96200.000, 183400.000, 344000.000, 525000.000, 49879.800, 97200.000, 191000.000, 344000.000, 528000.000,
    50443.200, 98231.750, 202070.000, 351300.000, 529000.000, 43762.600, 112000.000, 169010.000, 364960.000, 539000.000,
    55047.900, 120000.000, 188000.000, 269150.000, 551500.000, 60891.400, 131000.000, 186000.000, 282000.000, 389340.000,
    63427.700, 132000.000, 210000.000, 308000.000, 416000.000, 63181.600, 134000.000, 218000.000, 315000.000, 419000.000,
    68058.900, 137000.000, 202000.000, 331000.000, 444000.000, 72323.900, 137100.000, 226000.000, 323000.000, 460000.000,
    72257.800, 149700.000, 234000.000, 347000.000, 452000.000, 74409.110, 162950.000, 242000.000, 363000.000, 484000.000,
    84184.150, 151284.400, 277900.000, 391600.000, 493600.000, 49266.660, 164765.000, 240773.000, 412500.000, 505000.000,
    59819.558, 121245.280, 257592.000, 341435.100, 555000.000, 58761.650, 134720.000, 206180.000, 365900.000, 442400.000,
    67860.000, 156000.000, 220000.000, 290000.000, 460000.000, 75150.800, 144210.000, 214400.000, 319800.000, 406400.000,
    86692.500, 173000.000, 237000.000, 298000.000, 427000.000, 32848.872, 181000.000, 270000.000, 315000.000, 403000.000,
    42573.360, 81842.310, 250000.000, 331000.000, 427000.000, 43394.450, 94800.000, 140590.000, 361000.000, 444000.000,
    50867.000, 96000.000, 147800.000, 231060.000, 468000.000, 47500.000, 96000.000, 150000.000, 249000.000, 357000.000,
    49958.400, 94000.000, 159700.000, 296000.000, 371000.000, 50535.000, 93000.000, 159000.000, 273000.000, 387000.000,
    48601.000, 93000.000, 170000.000, 282000.000, 395000.000, 48182.000, 94000.000, 175000.000, 297000.000, 403000.000,
    48324.000, 100000.000, 162000.000, 304000.000, 411000.000, 49989.000, 96000.000, 174000.000, 290000.000, 452000.000,
    50665.000, 97000.000, 181000.000, 304000.000, 419000.000, 51358.000, 98000.000, 183000.000, 313000.000, 436000.000,
    0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000,
    0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000,
    0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000,
    0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000,
    0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000,
    0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000,
    0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000,
    0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000,
    0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000,
    0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000,
    0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000,
    0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000,
    0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000,
    0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000,
    0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000,
    0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000, 0.000
]

"""
    potion_array_available() -> Bool

Check if POTION ionization potential array is available.

Always returns true (data embedded in this module).
"""
function potion_array_available()::Bool
    return true
end

"""
    get_potion_array() -> Vector{Float64}

Get ionization potentials in eV units.

Returns 999-element array with ionization potentials in eV.
Converts from cm⁻¹ stored values by dividing by 8065.479.

# Returns
- `Vector{Float64}`: Ionization potentials in eV (999 elements)
"""
function get_potion_array()::Vector{Float64}
    return POTION_ARRAY_CM_INV ./ CM_INV_TO_EV
end

"""
    compute_potion_index(element::Int, ion_stage::Int) -> Int

Compute POTION array index from (element, ion_stage).

Maps atomic number and ionization stage to 1-indexed position in POTION array.

# Index Formula

Elements 1-30 use triangular indexing:
- H (Z=1): starts at index 1
- He (Z=2): starts at index 3 (= 1 + 2)
- Li (Z=3): starts at index 6 (= 1 + 2 + 3)
- Fe (Z=26): starts at index 351

Formula: index = Z*(Z+1)/2 + ion_stage + 1

Elements 31-99 use linear indexing (5 values each):
- Ga (Z=31): starts at index 496
- Es (Z=99): starts at index 836

Formula: index = 465 + (Z-30)*5 + ion_stage + 1

# Arguments
- `element::Int`: Atomic number (1-99)
- `ion_stage::Int`: Ionization stage (0=neutral, 1=singly ionized, ...)

# Returns
- `Int`: 1-indexed position in POTION array

# Example
```julia
idx = compute_potion_index(1, 0)   # H I → 1
idx = compute_potion_index(26, 0)  # Fe I → 351
idx = compute_potion_index(26, 1)  # Fe II → 352
```
"""
function compute_potion_index(element::Int, ion_stage::Int)::Int
    if element < 1 || element > 99
        throw(ArgumentError("Element must be 1-99, got $element"))
    end

    if ion_stage < 0
        throw(ArgumentError("Ion stage must be non-negative, got $ion_stage"))
    end

    # EQUIVALENCE indices from Fortran (1-indexed)
    const EQUIV_INDICES = [
        1,   # H
        3,   # He
        6,   # Li
        10,  # Be
        15,  # B
        21,  # C
        28,  # N
        36,  # O
        45,  # F
        55,  # Ne
        66,  # Na
        78,  # Mg
        91,  # Al
        105, # Si
        120, # P
        136, # S
        153, # Cl
        171, # Ar
        190, # K
        210, # Ca
        231, # Sc
        253, # Ti
        276, # V
        300, # Cr
        325, # Mn
        351, # Fe
        378, # Co
        406, # Ni
        435, # Cu
        465, # Zn
    ]

    if element <= 30
        # Elements 1-30: use EQUIVALENCE table
        start_idx = EQUIV_INDICES[element]
        return start_idx + ion_stage
    else
        # Elements 31-99: linear indexing (5 values each)
        # Ga (Z=31) starts at 496
        start_idx = 496 + (element - 31) * 5
        return start_idx + ion_stage
    end
end

"""
    get_ionization_potential(element::Int, ion_stage::Int) -> Float64

Get ionization potential for specific element and ion stage.

Returns the energy required to remove one electron from the specified ion.

# Arguments
- `element::Int`: Atomic number (1-99)
- `ion_stage::Int`: Ionization stage (0=neutral, 1=singly ionized, ...)

# Returns
- `Float64`: Ionization potential in eV (0.0 if fully ionized)

# Validation
Checks that:
- Element is 1-99
- Ion stage is 0 to Z (max ionization)
- For elements 31-99, ion stage ≤ 4 (only 5 values stored)

# Example
```julia
χ_HI = get_ionization_potential(1, 0)   # 13.598 eV (H I → H II)
χ_FeI = get_ionization_potential(26, 0) # 7.902 eV (Fe I → Fe II)
χ_FeII = get_ionization_potential(26, 1) # 16.199 eV (Fe II → Fe III)
```

# Physical Meaning

χ_ion is the energy to ionize from stage `ion_stage` to `ion_stage + 1`:
- χ(H I) = 13.598 eV → remove electron from neutral H
- χ(Fe II) = 16.199 eV → remove electron from Fe⁺

When χ = 0.0, the ion is already fully ionized (no more electrons to remove).
"""
function get_ionization_potential(element::Int, ion_stage::Int)::Float64
    # Validate element
    if element < 1 || element > 99
        throw(ArgumentError("Element must be 1-99, got $element"))
    end

    # Validate ion stage
    if ion_stage < 0
        throw(ArgumentError("Ion stage must be non-negative, got $ion_stage"))
    end

    # Check maximum ionization for this element
    if ion_stage > element
        throw(ArgumentError("Ion stage $ion_stage exceeds maximum $element for element $element"))
    end

    # For elements 31-99, only 5 ionization stages stored
    if element >= 31 && ion_stage >= 5
        throw(ArgumentError("Elements 31-99 only have ionization stages 0-4 in POTION array"))
    end

    # Get index and retrieve value
    idx = compute_potion_index(element, ion_stage)

    # Convert from cm⁻¹ to eV
    χ_cm_inv = POTION_ARRAY_CM_INV[idx]
    χ_eV = χ_cm_inv / CM_INV_TO_EV

    return χ_eV
end

# Export functions
export potion_array_available
export get_potion_array
export compute_potion_index
export get_ionization_potential
